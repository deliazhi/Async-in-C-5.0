# 为什么需要异步编程
异步编程很重要也很有用的原因有很多，主要看你开发的是什么类型的应用程序。有些好处随处可见，但有些可能存在于你从未开发过的应用程序中。阅读本章作为背景知识将会帮助你理解正本书的内容。

### 用户界面的桌面应用程序
桌面应用程序有一个主要的性能要求，就是需要给用户可感受到的响应。HCI研究表明，用户不会关注响应慢的应用程序，所以在接口做出响应时最好有一个动态的进度条。

当应用程序没反应时人们会变得沮丧。没反应通常是因为在一个耗时操作中，程序无法给用户的输入做出及时的响应并返回结果。原因包括计算缓存或者是IO操作，例如网络请求。

你所使用的C#UI框架都是单个UI线程进行操作的。包括：
+ WinForms
+ WPF
+ Silverlight

UI线程是唯一可以控制特定窗口内容的。也是唯一验证用户行为并返回内容给用户的线程。如果这个线程繁忙或者哪怕是被阻塞了几十毫秒，用户也会觉得这个应用程序反应迟缓。

异步代码，哪怕是手工编写的，也意味着UI线程可以返回到它的主工作去检查用户事件的消息队列，并对它们进行响应。它还可以执行进度动画，以及最近Windows版本中的鼠标悬停动画都是给用户对于这个应用程序留下及时响应的良好印象的重要视觉提示。
> 所有常见UI框架都使用单线程的原因是为了简化同步。如果是多线程的话，为了避免一个线程在布局控件的同时，另一个线程在尝试读取按钮的宽度的冲突，你需要大量使用锁，这样反而导致性能比单线程更低。

##### 打个比方：咖啡馆
我想用一个类比来帮助我们直观地理解所涉及到的问题。如果你已经理解了，那么可以跳过此小节。

想想一下，有一家小咖啡馆给顾客提供面包作为早餐。唯一的员工就是老板自己。他非常注重客户服务，但他还没学会异步技术。

UI线程模型和咖啡馆的老板很相似。和计算机中事情必须通过一个线程去执行一样，只有咖啡馆的员工可以在咖啡馆里工作。而且只有一个员工，就好像只有一个UI线程一样。

第一个客人想要一片面包。老板取出面包并且放入烤箱，然后他就盯着烤箱运作。以致客人问他黄油在哪儿都被他忽略了，因为他被盯着烤箱阻塞了。五分钟后，面包烤好了，老板取出面包并递给客人。此时，已经排起长队，客人们对于被忽略表示很生气，这一点也不理想。

现在，让我们来教老板如何进行异步操作吧。

首先，老板要确保他的烤箱可以进行异步操作。当编写异步代码的时候，我们也需要知道耗时操作何时完成以便返回。所以，同样的，烤箱也需要有一个定时器，当面包烤好时可以响起铃声，以便通知老板。

下一步就是当烤箱运作时，老板忽略它而不是像以前那样盯着它，他应该继续去为客人提供服务。同样，我们的异步代码在遇到耗时操作时也需要返回以便UI线程可以去继续响应用户的操作。这有两个原因：
+ 可以更及时的响应用户——客人可以继续询问黄油在哪儿而不是被忽略。
+ 用户可以同时开始另一个操作——下一个客人可以开始点单。

咖啡馆老板现在可以同时服务多个客人了，只是受限于他所拥有的烤箱数量以及他去拿烤好的面包所耗费的时间。但这也带来了它特有的问题：老板发现他很难记住哪片面包是给哪个客人的。事实上，UI线程根本无法记住它返回继续执行用户事件时所等待的是哪个操作。

因此，当耗时操作开始的时候我们需要附加一个回调函数，以便提醒我们，当耗时操作完成时应该做什么。对于咖啡馆老板而言，很简单，只要在烤箱上贴上写有客人姓名的标签即可。我们也许还需要一些更复杂的东西，通常来讲，当耗时操作完成时，对于我们需要做的事情希望可以提供一个完整的说明。

有了这些，咖啡馆老板现在是完全异步的了，而且生意兴隆。客人的体验也好了很多。更少的等待时间，更快的服务响应。我希望这个类比可以帮助你理解为什么异步对于UI应用程序如此重要。
### Web应用程序的服务端代码
尽管ASP.NET的Web服务器没有像UI代码一样只有一个线程的限制，但使用异步编程依然有很多好处。耗时操作，尤其是远程数据库查询，在web应用程序的代码中非常常见。

对于处理Web请求的线程总数或者处理并发请求的总数的限制取决于你IIS的版本。如果你的请求大部分时间都在等待数据库查询，那么增加同步请求的数量来增加服务器处理的吞吐量似乎是个好主意。

当一个线程被阻塞，出于等待状态，它并不占用CPU时间。然而，不要想当然的以为它就不使用你服务器的任何资源了。事实上，线程会导致两个重要的开销，即使它们被阻塞了：
+ 内存
每个托管线程在Windows上大约占用一兆字节的虚拟内存。如果是几十个线程那没问题，但如果有几百个线程就会变得很容易失控。当内存不够开始使用磁盘空间时，恢复线程将会变得十分缓慢。
+ 调度器开销
操作系统调度器的职责是确定什么时候在哪个CPU上去执行哪个线程。即使线程阻塞时，调度器也需要把阻塞的线程考虑在内，并及时判断它们是否脱离阻塞状态。这降低了上下文的切换速度，甚至拖慢整个系统。

这两者的这些开销会加重服务器的负载，增加延迟，降低吞吐量。

记住：异步编程的主要特征就是线程在开始运行一个耗时操作时可以被释放去做其他的事情。在ASP.NET代码中，线程来自线程池，所以在耗时操作期间线程会返回到线程池，以便可以处理其他请求，这样，只需更少的线程去处理相同数量的请求。
##### 再打个比方：餐厅的厨房